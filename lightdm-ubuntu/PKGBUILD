# Maintainer: Xiao-Long Chen <chenxiaolong@cxl.epac.to>

# This package no longer depends on a specific toolkit. It will build the GTK and
# Qt libraries and recommend the installation of those respective tookits using
# optdepends.

pkgname=lightdm-ubuntu
_ubuntu_rel=0ubuntu1
pkgver=1.5.1
pkgrel=2.${_ubuntu_rel}
pkgdesc="A lightweight display manager"
arch=('i686' 'x86_64')
url="https://launchpad.net/lightdm"
# Libraries are LGPLv3+, everything else is GPLv3+
license=('GPL3' 'LGPL3')
groups=('unity-extra')
# Is dbus-glib still needed or is debian/control out of date?
depends=('libgcrypt' 'libxcb' 'libxdmcp' 'libxklavier')
# Useful dependencies, but not required
#depends=('gnome-themes-standard' 'gnome-backgrounds' 'gnome-icon-theme' 'webkitgtk3')
makedepends=('gnome-common' 'gobject-introspection' 'gtk-doc' 'gtk3' 'intltool' 'qt4' 'qt5-base' 'yelp-tools')
optdepends=('accountsservice: DBus interface for querying user information'
            'gnome-keyring: For pam_gnome_keyring.so in the greeter PAM config'
            'gtk3: For using the GTK greeter'
            'lightdm-unity-greeter: Default Ubuntu 13.04 Greeter'
            'qt4: To use the qt4 version of liblightdm-qt'
            'qt5-base: To use the qt5 version of liblightdm-qt')
provides=("lightdm=${pkgver}")
conflicts=('lightdm')
options=('!libtool' 'emptydirs')
backup=('etc/apparmor.d/lightdm-guest-session'
        'etc/lightdm/keys.conf'
        'etc/lightdm/lightdm.conf'
        'etc/lightdm/lightdm-gtk-greeter.conf'
        'etc/lightdm/lightdm-gtk-greeter-ubuntu.conf'
        'etc/lightdm/users.conf')
install=lightdm.install
source=("https://launchpad.net/ubuntu/+archive/primary/+files/lightdm_${pkgver}.orig.tar.xz"
        "https://launchpad.net/ubuntu/+archive/primary/+files/lightdm_${pkgver}-${_ubuntu_rel}.debian.tar.gz"
        'lightdm.service'
        'lightdm-plymouth.service'
        'lightdm-gtk-greeter.conf'
        'lightdm.tmpfiles.d'
        'lightdm.pam'
        'lightdm-autologin.pam'
        'lightdm-greeter.pam'
        'lightdm.rules'
        'guest-session-cross-distro.patch'
        'guest-session-add-default-gsettings-support.patch'
        'guest-session-fix-gconf-error.patch'
        '0001_pam_systemd.patch'
        'lightdm-1.5.1-systemd_login1_power.patch'
        'lightdm-lock-screen-before-switch.patch')
noextract=("lightdm_${pkgver}-${_ubuntu_rel}.debian.tar.gz")
sha512sums=('e7a7fab1ad3b717e8c9de48e0337985ccbca5c3850697d59c910ed0a2418339207a1111e197f0f7a2a2b0ad6800373681c29d8f683e4a5ee3ae74a72b51e9da2'
            'a2813c9a947f64a8d292e4c81fe439c40cb325f8f1d7c580380f50a8ef89ce1f2585779a1806aac28cc924e125120a19798be5c8ce4c0ad577d46d5ab5d06971'
            '26bb333e58ee63a6a0d472bb0a7f9006b93c7de629780399b1dff4af3aaccea02aa74ed0410b8fa6ba55b285f7c7bb6180db059928feba56f779c5b8f3ba8b86'
            'a13e7df200a6aa7e8e62df9fc2382234258041b30654446e51c48ea9fac7d1128dbbb6ff17a5abca06fbeb1b09c2076f45620a8c58b435d56059abc674917fb3'
            'fa35ece114255abfc409f1c9da1eb7129055d8669aad11fe3d69084bf2216e93bf09864ac4e8874e88f166be9735fc55ed899056eb3bd94c5b33d3b2cbd55f4d'
            '81a76a49eb208b1d33f5ac0184d87a377cd37c522d74a93ccd3d96b3d6e32c44872a65873b91fec3daba0846cdb5a938b51944697e636c045d03259bd5424644'
            '5be3d58cb63ecf80674a59b8cb07fa47bb6c7a63b827786a37d9938ed32a2024abeb8f58ef77e8013d790fc2b65a861c903af906ea4e45b1d6d3c8f1434e1a8f'
            '5a940262702adf31a25a2184236ec5018391ed1c501dd576e38791793cad09c03f1b0849cf3bfcf294330f61a5742f6029d2b6793ac852c2255369b47827ad02'
            '3b482f7e551df20a5c5d9331a420275d1dad5bb6aad287247baea82dc40dc31dca22db4da180fbb950865e37cf94f1737fa1ee7ec2f5233540f82f2f570a408b'
            '8d6aa12c4d129c25e56ecf2904db4e294d46631d11bd8bec2f20a76c871ba758094abb24616d3d2038a684fbb736ee61d1f80697d525d62c4dc68113e101194f'
            'f573581ccbfaf4502276b80338ac91cd3a42820dfa06317cdffc1142f7282cc20d350ec466e1822a3774a74af718905db82acc9c780cf28552db0744ef8a6369'
            '501b51b7adf34fb2e3cb54e2de8cc6ed1c404288d3e9e6d871d45579c3a0b3c313c77916c21713273095dffb8f2311f639c2771dbf08c395bce2f264c73e9171'
            '2ba40c28e296e8c1c8f828e8ec3a658dde2da30f44ff6daa56097b2f657b46aec13f0184f2f6b27a022aaa15ca7a4ff402e4c22f5642e483de84ac79ef3bb5ab'
            'd2eb6874601ef6e3918c587ddc9029ad23dfdf424f3c76ff9fe4ebabfcc09d7db272a88965408855e37534c4d52c65454f46967f41a679454c84b045965b93fa'
            '63ce9b6c666d601531e48522f3a944dcd9be48cf509f8344578aded89f5a7c6dffdc93e4e54bb0ac17df8e8738a4ca6f5cb1c1147d8899213fd8ce618be7336d'
            '2e1c78c0112c4e176da4c672a394168020c674288b0f2a16d27daab1438d0753b51bd98c21a7a0fb5b5d01c0900a72f8c8a170907fad761087062fc821b40641')

build() {
  cd "${srcdir}/lightdm-${pkgver}"

  # Apply Ubuntu patches
  tar zxvf "${srcdir}/lightdm_${pkgver}-${_ubuntu_rel}.debian.tar.gz"

  # Disable patches
    # Do not use Ubuntu's language-tools
      sed -i '/04_language_options.patch/d' debian/patches/series

  for i in $(grep -v '#' debian/patches/series); do
    patch -p1 -i "debian/patches/${i}"
  done

  # Do not depend on Debian/Ubuntu specific adduser package
  patch -p1 -i "${srcdir}"/guest-session-cross-distro.patch

  # Add support for settings GSettings/dconf defaults in the guest session. Just
  # put the files in /etc/guest-session/gsettings/. The file format is the same
  # as the regular GSettings override files.
  patch -p1 -i "${srcdir}"/guest-session-add-default-gsettings-support.patch

  # Fix issue where gconf cannot connect to the DBus session, causing
  # guest-account to terminate unsuccessfully.
  patch -p1 -i "${srcdir}"/guest-session-fix-gconf-error.patch

  # Make sure pam_systemd.so is used so the network manager applet works
  # properly.
  patch -p1 -i "${srcdir}"/0001_pam_systemd.patch

  # Patch from Fedora to use systemd's login1 interface. This patch should no
  # longer be needed once Ubuntu finishes their shift to systemd-logind (Ubuntu
  # 13.04 cycle).
  patch -p1 -i "${srcdir}"/lightdm-1.5.1-systemd_login1_power.patch

  # Patch from Fedora to lock the screen before switching users.
  patch -p1 -i "${srcdir}"/lightdm-lock-screen-before-switch.patch

  aclocal --install --force
  autoreconf -vfi

  ./configure \
    --prefix=/usr \
    --sysconfdir=/etc \
    --disable-static \
    --libexecdir=/usr/lib/lightdm \
    --localstatedir=/var \
    --with-user-session=ubuntu \
    --with-greeter-user=lightdm

  make
}

check() {
  # Tests require LightDM to be installed
  return
}

package() {
  cd "${srcdir}/lightdm-${pkgver}"
  make DESTDIR="${pkgdir}/" install

  install -dm755 "${pkgdir}/usr/lib/systemd/system/"

  # Please fix your Makefile
  mv "${pkgdir}"/usr/lib/lightdm/lightdm/lightdm-set-defaults \
     "${pkgdir}"/usr/lib/lightdm/

  # Install PAM service
  install -dm755  "${pkgdir}"/etc/pam.d/
  install -m644 "${srcdir}"/lightdm.pam "${pkgdir}"/etc/pam.d/lightdm
  install -m644 "${srcdir}"/lightdm-autologin.pam \
                "${pkgdir}"/etc/pam.d/lightdm-autologin
  install -m644 "${srcdir}"/lightdm-greeter.pam \
                "${pkgdir}"/etc/pam.d/lightdm-greeter

  # Install configuration files
  install -dm755 "${pkgdir}"/usr/share/doc/lightdm/
  install -m644 "${pkgdir}"/etc/lightdm/lightdm.conf \
                "${pkgdir}"/usr/share/doc/lightdm/
  install -m644 "${pkgdir}"/etc/lightdm/keys.conf \
                "${pkgdir}"/usr/share/doc/lightdm/
  install -m644 "${srcdir}"/lightdm-gtk-greeter.conf "${pkgdir}"/etc/lightdm/

  # Install binaries and scripts
  install -dm755 "${pkgdir}"/usr/sbin/
  install -m755 debian/guest-account "${pkgdir}"/usr/sbin/
  install -m755 debian/lightdm-session "${pkgdir}"/usr/sbin/
  install -m755 debian/lightdm-greeter-session "${pkgdir}"/usr/lib/lightdm/
  chmod +x "${pkgdir}"/usr/lib/lightdm/lightdm-greeter-session

  # Install systemd service
  install -m644 "${srcdir}"/lightdm.service "${pkgdir}"/usr/lib/systemd/system/
  install -m644 "${srcdir}"/lightdm-plymouth.service \
                "${pkgdir}"/usr/lib/systemd/system/

  # Install systemd tmpfiles.d file
  install -dm755 "${pkgdir}"/usr/lib/tmpfiles.d/
  install -m644 "${srcdir}"/lightdm.tmpfiles.d \
                "${pkgdir}"/usr/lib/tmpfiles.d/lightdm.conf

  # Install PolicyKit rules from Fedora which allow the lightdm user to access
  # the systemd-logind, consolekit, and upower DBus interfaces
  install -dm700 "${pkgdir}"/usr/share/polkit-1/rules.d/
  install -m644 "${srcdir}"/lightdm.rules \
                "${pkgdir}"/usr/share/polkit-1/rules.d/

  # Configuration settings that differ from Ubuntu
  sed -i \
    -e 's/^\(minimum-uid=\).*$/\11000/g' \
    -e 's@/usr\(/sbin/nologin\)$@\1@g' \
    "${pkgdir}"/etc/lightdm/users.conf

  # Configuration files specific to Ubuntu
  rm -rvf "${pkgdir}"/etc/init/

  # Create GSettings defaults directory
  install -dm755 "${pkgdir}"/etc/guest-session/gsettings/
}

# vim:set ts=2 sw=2 et:
